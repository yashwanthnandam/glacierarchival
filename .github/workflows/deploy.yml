name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SERVER_IP: 3.110.26.97
  SERVER_USER: ec2-user
  PROJECT_DIR: /home/ec2-user/glacierarchival

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js and build frontend
      run: |
        cd frontend
        npm ci
        cat > .env << 'EOF'
        VITE_API_BASE_URL=https://datahibernate.in/api/
        VITE_APP_NAME=Data Hibernate
        VITE_APP_VERSION=1.0.0
        VITE_DEBUG=false
        VITE_LOG_LEVEL=warn
        VITE_USE_SECURE_AUTH=true
        VITE_CSRF_TRUSTED_ORIGINS=https://datahibernate.in,https://www.datahibernate.in
        VITE_ENABLE_ANALYTICS=true
        VITE_ENABLE_OFFLINE_MODE=true
        VITE_ENABLE_PWA=false
        VITE_THEME=light
        VITE_LANGUAGE=en
        VITE_TIMEZONE=UTC
        EOF
        npm run build
        
    - name: Commit build files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -f frontend/dist/
        git diff --staged --quiet || git commit -m "Build frontend for deployment [skip ci]"
        
    - name: Upload frontend build to server
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ env.SERVER_IP }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "frontend/dist/*"
        target: "/home/ec2-user/glacierarchival/frontend/dist/"
        rm: true
        overwrite: true
        debug: true
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 20m
        command_timeout: 15m
        script: |
          set -e
          cd ${{ env.PROJECT_DIR }}
          
          echo "ğŸ”„ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ”„ Verifying frontend files..."
          ls -la frontend/dist/
          echo "Frontend files uploaded successfully"
          
          echo "ğŸ”„ Setting up environment variables..."
          cat > backend/.env << 'EOF'
          # Production Environment Configuration
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=datahibernate.in,www.datahibernate.in,localhost,127.0.0.1
          
          # CORS Settings
          CORS_ALLOWED_ORIGINS=https://datahibernate.in,https://www.datahibernate.in
          CSRF_TRUSTED_ORIGINS=https://datahibernate.in,https://www.datahibernate.in
          
          # Email Configuration
          EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
          EMAIL_HOST=smtpout.secureserver.net
          EMAIL_PORT=587
          EMAIL_USE_TLS=True
          EMAIL_USE_SSL=False
          EMAIL_HOST_USER=yashwanth@datahibernate.in
          EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL=DataHibernate <yashwanth@datahibernate.in>
          
          # Frontend URL
          FRONTEND_URL=https://datahibernate.in
          
          # AWS Configuration
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_STORAGE_BUCKET_NAME=datahibernate-storage-1760174502
          AWS_REGION=ap-south-1
          
          # Security
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          
          # Payment Configuration
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.RAZORPAY_KEY_SECRET }}
          EOF
          
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          export EMAIL_HOST_PASSWORD='${{ secrets.EMAIL_HOST_PASSWORD }}'
          export RAZORPAY_KEY_ID='${{ secrets.RAZORPAY_KEY_ID }}'
          export RAZORPAY_KEY_SECRET='${{ secrets.RAZORPAY_KEY_SECRET }}'
          export SECRET_KEY='${{ secrets.SECRET_KEY }}'
          export ENCRYPTION_KEY='${{ secrets.ENCRYPTION_KEY }}'
          
          echo "ğŸ”„ Building updated services (using cache)..."
          docker-compose -f docker-compose.production.yml build
          
          echo "ğŸ”„ Running migrations before deployment..."
          # Start only postgres and redis if not running
          docker-compose -f docker-compose.production.yml up -d postgres redis
          sleep 5
          
          # Start backend temporarily for migrations
          docker-compose -f docker-compose.production.yml up -d backend
          sleep 10
          
          # Wait for database
          timeout 60 bash -c 'until docker exec glacierarchival-backend-1 python manage.py check --database default 2>/dev/null; do sleep 2; done'

          # Wait for Redis to be ready
          echo "ğŸ”„ Waiting for Redis to be ready..."
          timeout 30 bash -c 'until docker exec glacierarchival-redis-1 redis-cli ping 2>/dev/null | grep -q PONG; do sleep 2; done' || echo "âš ï¸ Redis not ready, continuing anyway"
          
          # Run migrations
          docker exec glacierarchival-backend-1 python manage.py migrate
          
          # Collect static files
          docker exec glacierarchival-backend-1 python manage.py collectstatic --noinput --clear
          
          echo "ğŸ”„ Deploying all services..."
          docker-compose -f docker-compose.production.yml up -d
          
          echo "ğŸ”„ Fixing Nginx configuration..."
          sudo sed -i 's/proxy_pass http:\/\/127.0.0.1:3000;/proxy_pass http:\/\/127.0.0.1:8080;/' /etc/nginx/conf.d/datahibernate.conf 2>/dev/null || true
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "â³ Waiting for services to be healthy..."
          sleep 15
          
          echo "ğŸ”„ Health check..."
          docker-compose -f docker-compose.production.yml ps
          
          # Verify backend is responding
          for i in {1..10}; do
            if docker exec glacierarchival-backend-1 python manage.py check 2>/dev/null; then
              echo "âœ… Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($i/10)"
            sleep 3
          done
          
          echo "âœ… Deployment completed!"
          
    - name: Print logs on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: ${{ env.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ${{ env.PROJECT_DIR }}
          echo "ğŸ”„ Container status..."
          docker-compose -f docker-compose.production.yml ps
          echo ""
          echo "ğŸ”„ Backend logs (last 100 lines)..."
          docker-compose -f docker-compose.production.yml logs --tail=100 backend
          echo ""
          echo "ğŸ”„ Frontend logs (last 50 lines)..."
          docker-compose -f docker-compose.production.yml logs --tail=50 frontend
          echo ""
          echo "ğŸ”„ Postgres logs (last 30 lines)..."
          docker-compose -f docker-compose.production.yml logs --tail=30 postgres
          
    - name: Health check
      run: |
        echo "ğŸ”„ Starting external health check..."
        for i in {1..6}; do
          echo "Attempt $i/6..."
          if curl -f -s -o /dev/null -w "%{http_code}" https://datahibernate.in/ | grep -q "200\|301\|302"; then
            echo "âœ… Site is responding!"
            exit 0
          fi
          echo "Waiting... ($i/6)"
          sleep 10
        done
        echo "âš ï¸ Site health check inconclusive"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸš€ Deployment successful!"
          echo "ğŸŒ Site: https://datahibernate.in"
        else
          echo "âŒ Deployment failed!"
        fi